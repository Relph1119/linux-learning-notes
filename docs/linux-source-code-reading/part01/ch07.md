# 第7回 六行代码进入保护模式

代码路径：`boot/setup.s`

## 7.1 开启A20地址线

```nasm
call    empty_8042
mov	al,#0xD1		; command write
out	#0x64,al
call    empty_8042
mov	al,#0xDF		; A20 on
out	#0x60,al
call    empty_8042
```

上述代码表示打开A20地址线，目的是为了突破地址信号线20位宽度，变成32位可用。

## 7.2 对可编程中断控制器8259A芯片进行编程

- 编程原因：由于中断号是不能冲突的，Intel把`0~0x19`中断都作为保留中断，但是IBM原始计算机中发生了冲突。
- 重新编程结果：

| PIC请求号 | 中断号  |   用途   |
|:------:|:----:|:------:|
|  IRQ0  | 0x20 |  时钟中断  |
|  IRQ1  | 0x21 |  键盘中断  |
|  IRQ2  | 0x22 | 连接从芯片  |
|  IRQ3  | 0x23 |  串口2   |
|  IRQ4  | 0x24 |  串口1   |
|  IRQ5  | 0x25 |  并口2   |
|  IRQ6  | 0x26 | 软盘驱动器  |
|  IRQ7  | 0x27 |  并口1   |
|  IRQ8  | 0x28 | 实时钟中断  |
|  IRQ9  | 0x29 |   保留   |
| IRQ10  | 0x2a |   保留   |
| IRQ11  | 0x2b |   保留   |
| IRQ12  | 0x2c |  鼠标中断  |
| IRQ13  | 0x2d | 数字协处理器 |
| IRQ14  | 0x2e |  硬盘中断  |
| IRQ15  | 0x2f |   保留   |

## 7.3 模式切换

```nasm
mov	ax,#0x0001	; protected mode (PE) bit
lmsw	ax		; This is it;
jmpi	0,8		; jmp offset 0 of segment 8 (cs)
```

上述代码解释：
- 将cr0寄存器的第0位设置为1，从实模式切换到保护模式。
- 当切换到保护模式，内存寻址方式改变，段寄存器里的值当作段选择子，描述符索引为1

| 描述符索引<br/>第15~3位 | TI<br/>第2位 | RPL<br/>第1~0位 |
|:----------------:|:----------:|:-------------:|
|       0x01       |     0      |      00       |

- 到全局描述符表中查找索引为1的描述符，得到代码段描述符，可得段基址为0，偏移是0。
- `jmpi`指令将跳转到零地址位置。